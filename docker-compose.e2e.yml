networks:
  proxynet:
    name: sf-website-development
    external: true

services:
  localstack:
    image: localstack/localstack:2.2
    container_name: apostrophe-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/tmp/localstack/data
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_DEFAULT_REGION=us-east-1
      - HOSTNAME_EXTERNAL=localstack
    volumes:
      - localstack-data:/tmp/localstack
      - ./init-localstack.sh:/etc/localstack/init/ready.d/init-localstack.sh
    networks:
      - proxynet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localstack:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 3

  playwright-test:
    container_name: apostrophe-playwright-test
    build:
      context: ./website/e2e
      dockerfile: Dockerfile
    depends_on:
      apostrophe:
        condition: service_started
      localstack:
        condition: service_healthy
    environment:
      - BASE_URL=http://apostrophe:3000
      - WAIT_HOSTS=apostrophe:3000,localstack:4566
      - WAIT_TIMEOUT=60
    networks:
      - proxynet
    volumes:
      - test-snapshots-data:/e2e/tests/screenshot-test.spec.js-snapshots
      - playwright-report-data:/e2e/playwright-report
      - test-results-data:/e2e/test-results

volumes:
  test-snapshots-data:
  playwright-report-data:
  test-results-data:
  localstack-data:
